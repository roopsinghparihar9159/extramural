{% extends 'account/main.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<style>
    .table thead th {
        font-size: .80rem !important;
        letter-spacing: 0px !important;
        padding: 8px 10px !important;
        background-color: #58a2d7 !important;
        color:#fff !important;
    }
    /* .table>:not(caption)>*>* {
        background-color: #58a2d7 !important;
        color:#fff !important;
    } */
    /* #SansionTbody>tr>td {
        background-color: #fff !important;
        color:#111010 !important;
    } */
    /* #ReleaseTbody>tr>td {
        background-color: #fff !important;
        color:#111010 !important;
    } */
    #UCTbody>tr>td {
        background-color: #fff !important;
        /* color:#111010 !important; */
    }
    input{
        width: 100%;
    }
    .table>tbody>tr>td{
        padding: 16px 5px !important;
    }
    .comment{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        display: inline-block;
    }
    .input_modal{
        padding-top: 4px !important;
        padding-bottom: 4px !important;
    }
    .modal-header {
        padding: 8px 14px !important;
        background-color: #a097f0 !important;
        color: #fff !important;
    }
    .modal-footer{
        padding: 6px 10px !important;
    }
</style>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Sanction Budget</div>
            </div>
            <div class="card-body ">
                <div class="col-lg-12 table-responsive">
                    <table id="sansion-table" class="table p-3 text-center">
                        <thead class="text-dark main-head">
                            <tr>
                            <th class="th_width expand-icon"><i class="fa fa-plus"></i></th>
                            <th class="th_width">Project Year</th>
                            <th class="th_width">Salary</th>
                            <th class="th_width">Contin gencies</th>
                            <th class="th_width">Non-contin gencies</th>
                            <th class="th_width">Recurring</th>
                            <th class="th_width">Travel</th>
                            <th class="th_width">Overhead expens</th>
                            <th class="th_width">Total Amount</th>
                            <th class="th_width">Sub Total</th>
                            <th class="th_width"><button type="button" id="addnewrow" class="btn btn-success btn-sm p-1" onclick="AddNewrow()">Add Year</button></th>
                            </tr>
                        </thead>
                        <tbody id="SansionTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Release Budget</div>
            </div>
            <div class="card-body ">
                <div class="alert alert-danger text-center" role="alert" id="id_selectYearMsgRelease"></div>
                <div class="col-lg-12 table-responsive">
                    
                    <table id="release-table" class="table text-center">
                        <thead class="text-dark main-head">
                            <tr>
                            <th class="th_width expand-icon"><i class="fa fa-plus"></i></th>
                            <th class="th_width">Project Year</th>
                            <th class="th_width">Salary</th>
                            <th class="th_width">Contin gencies</th>
                            <th class="th_width">Non-contin gencies</th>
                            <th class="th_width">Recurring</th>
                            <th class="th_width">Travel</th>
                            <th class="th_width">Overhead expens</th>
                            <th class="th_width">Total Amount</th>
                            <th class="th_width">Remarks</th>
                            <th class="th_width">PDF</th>
                            <th class="th_width"><button type="button" id="addRelease" class="btn btn-success btn-sm p-1" onclick="AddRelease()">Add Release</button></th>
                            </tr>
                        </thead>
                        <tbody id="ReleaseTbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="card-title">UC Budget</div>
            </div>
            <div class="card-body">
                <div class="alert alert-danger text-center" role="alert" id="id_selectYearMsguc"></div>
                <div class="col-lg-12 table-responsive">
                    <table id="uc-table" class="table p-3 text-center">
                        <thead class="text-dark main-head">
                            <tr>
                            <th class="th_width expand-icon"><i class="fa fa-plus"></i></th>
                            <th class="th_width">Project Year</th>
                            <th class="th_width">Salary</th>
                            <th class="th_width">Contin gencies</th>
                            <th class="th_width">Non-contin gencies</th>
                            <th class="th_width">Recurring</th>
                            <th class="th_width">Travel</th>
                            <th class="th_width">Overhead expens</th>
                            <th class="th_width">Total Amount</th>
                            <th class="th_width">Interest</th>
                            <th class="th_width">Remarks</th>
                            <th class="th_width">PDF</th>
                            <th class="th_width"><button type="button" id="addnewrow" class="btn btn-success btn-sm p-1" onclick="Adduc()">Add UC</button></th>
                            </tr>
                        </thead>
                        <tbody id="UCTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Balance table -->

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Balance</div>
            </div>
            <div class="card-body">
                <div class="col-lg-12 table-responsive">
                    <table id="balance-table" class="table p-3 text-center">
                        <thead class="text-dark main-head">
                            <tr>
                            <th class="th_width expand-icon"><i class="fa fa-plus"></i></th>
                            <th class="th_width">Project Year</th>
                            <th class="th_width">Salary</th>
                            <th class="th_width">Contin gencies</th>
                            <th class="th_width">Non-contin gencies</th>
                            <th class="th_width">Recurring</th>
                            <th class="th_width">Travel</th>
                            <th class="th_width">Overhead expens</th>
                            <th class="th_width">Interest</th>
                            <th class="th_width">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody id="balanceTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Balance Sheet table -->

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Balance Sheet</div>
            </div>
            <div class="card-body">
                <div class="col-lg-12 table-responsive">
                    <table id="balancesheet-table" class="table p-3 text-center">
                        <thead class="text-dark main-head">
                            <tr id="headerRow">
                            <th class="">Heads</th>
                            
                            </tr>
                        </thead>
                        <tbody id="balanceSheetTbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- update modal for finance year -->
 <!-- Button trigger modal -->
<!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sanctionModal">
  Launch demo modal
</button> -->

<!-- Modal -->
<div class="modal fade" id="sanctionModal" tabindex="-1" aria-labelledby="sanctionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="sanctionModalLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="">
            <label for="sanction-year" class="col-form-label">Year:</label>
            <input type="text" class="form-control input_modal" id="id_sanctionYear">
          </div>
          <div class="">
            <label for="sanction-salary" class="col-form-label">Salary:</label>
            <input type="text" class="form-control input_modal" id="id_sanctionSalary">
          </div>
           <div class="">
            <label for="sanction-year" class="col-form-label">Contingencies:</label>
            <input type="text" class="form-control input_modal" id="id_sanctionContin">
          </div>
          <div class="">
            <label for="sanction-salary" class="col-form-label">Noncontingencies:</label>
            <input type="text" class="form-control input_modal" id="id_sanctionNonContin">
          </div>
           <div class="">
            <label for="sanction-year" class="col-form-label">Recurring:</label>
            <input type="text" class="form-control input_modal" id="id_sanctionRecurring">
          </div>
          <div class="">
            <label for="sanction-salary" class="col-form-label">Overhead expense:</label>
            <input type="text" class="form-control input_modal" id="id_sanctionOverhead">
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary btn-sm">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- update modal for release budget -->

<!-- Modal -->
<div class="modal fade" id="releaseModal" tabindex="-1" aria-labelledby="releaseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="releaseModalLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="">
            <label for="release-year" class="col-form-label">Year:</label>
            <input type="text" class="form-control input_modal" id="id_releaseYear">
          </div>
          <div class="">
            <label for="release-salary" class="col-form-label">Salary:</label>
            <input type="text" class="form-control input_modal" id="id_releaseYear">
          </div>
           <div class="">
            <label for="release-year" class="col-form-label">Contingencies:</label>
            <input type="text" class="form-control input_modal" id="id_releaseYear">
          </div>
          <div class="">
            <label for="release-salary" class="col-form-label">Noncontingencies:</label>
            <input type="text" class="form-control input_modal" id="id_releaseYear">
          </div>
           <div class="">
            <label for="release-year" class="col-form-label">Recurring:</label>
            <input type="text" class="form-control input_modal" id="id_releaseYear">
          </div>
          <div class="">
            <label for="release-salary" class="col-form-label">Overhead expense:</label>
            <input type="text" class="form-control input_modal" id="id_releaseYear">
          </div>
           <div class="">
            <label for="release-salary" class="col-form-label">Remarks:</label>
            <input type="text" class="form-control input_modal" id="id_releaseRemarks">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- update modal for uc budget -->

<!-- Modal -->
<div class="modal fade" id="ucModal" tabindex="-1" aria-labelledby="ucModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="ucModalLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
         <form>
          <div class="">
            <label for="uc-year" class="col-form-label">Year:</label>
            <input type="text" class="form-control input_modal" id="id_ucYear">
          </div>
          <div class="">
            <label for="uc-salary" class="col-form-label">Salary:</label>
            <input type="text" class="form-control input_modal" id="id_ucSalary">
          </div>
           <div class="">
            <label for="uc-contingencies" class="col-form-label">Contingencies:</label>
            <input type="text" class="form-control input_modal" id="id_ucContin">
          </div>
          <div class="">
            <label for="uc-noncontingencies" class="col-form-label">Noncontingencies:</label>
            <input type="text" class="form-control input_modal" id="id_ucNonContin">
          </div>
           <div class="">
            <label for="uc-recurring" class="col-form-label">Recurring:</label>
            <input type="text" class="form-control input_modal" id="id_ucRecurring">
          </div>
          <div class="">
            <label for="uc-overhead" class="col-form-label">Overhead expense:</label>
            <input type="text" class="form-control input_modal" id="id_ucOverheadExpense">
          </div>
          <div class="">
            <label for="uc-interest" class="col-form-label">Interest:</label>
            <input type="text" class="form-control input_modal" id="id_ucInterest">
          </div>
          <div class="">
            <label for="uc-remarks" class="col-form-label">Remarks:</label>
            <input type="text" class="form-control input_modal" id="id_ucRemarks">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary btn-sm">Save changes</button>
      </div>
    </div>
  </div>
</div>



<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script>
function reloadTable() {
    outerRowCount = 0
    countInner = 0
    $('#addnewrow').css('display','')
    $('#sansion-table tbody').empty();
    var financial_record_url = "{% url 'financial_record' %}";

    // var project_id = $('#id_project_detail_filter').val();
    // var projectpi_id = $('#id_project_pi_select').val();

    const params_get = new URLSearchParams(document.location.search);
    const pi_id = params_get.get("pi_id");
    const projectid = params_get.get("project_id");

    // console.log('pi_id',pi_id)
    // console.log('projectid',projectid)

    var project_id = projectid
    var projectpi_id = pi_id
    const baseURL = "http://10.1.19.176:8000/sansion_year_fetch/";
    const params = {
    projectpi_id: projectpi_id,
    project_id: project_id,
    };

    const url = new URL(baseURL);
    url.search = new URLSearchParams(params).toString();

    // console.log('projectpi_id reloadTable',projectpi_id)
    // console.log('project_id reloadTable',project_id)
    
    fetch(url.toString())
        .then(response => {
            // Check if the request was successful (e.g., status code 200)
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json(); // Parse the response as JSON
        })
        .then(data => {
            // console.log(data); 
           // console.log('financial_record_url',data); 
             $('#sansion-table tbody').empty(); 
            // var firstcall = $('#sansion-table tbody tr').length - 1
            //const jsonData = data
            const $tbody = $('#sansion-table tbody');

            // Render main table rows
            //   <td class="outer-file">${person.file}</td> 
            // if (firstcall === 0){
            //     AddNewrow();
                
            // }else{$('#newrow').remove()}
            data.newData.forEach((sension, index) => {
                // outerRowCount += 1
                // console.log('******************************* index',index)
            // if (index == '4'){$('#addnewrow').css('display','none')}
            
            const mainRow = `
                <tr id="Trow-${index}" class="main-row" data-index="${index}" data-set-id="${sension.id}">
                <td>
                    <input type="radio" name="financial_select" value="${ sension.id }">
                </td>
                <td class="outer-year text-warning">${sension.year}</td>
                <td class="outer-salary text-muted">${sension.salary}</td>
                <td class="outer-contingencies text-muted">${sension.contingencies}</td>
                <td class="outer-non_contingencies text-muted">${sension.non_contingencies}</td>
                <td class="outer-recurring text-muted">${sension.recurring}</td>
                <td class="outer-travel text-muted">${sension.travel}</td>
                <td class="outer-overhead_expens text-muted">${sension.overhead_expens}</td>
                <td class="outer-total text-success">${sension.total}</td>
                <td class="outer-comment text-danger">${sension.subtotal}</td>
                <td class=""><a href="#" class="text-warning" data-bs-toggle="modal" data-bs-target="#sanctionModal"><i class="far fa-edit"></i></a></td>
                </tr>
            `;
            
            $tbody.append(mainRow);
            });
            
            const columnSums = {};

                data.data.forEach(row => {
                Object.keys(row).forEach(key => {
                    if (typeof row[key] === 'number' && key !== 'id') {
                    columnSums[key] = (columnSums[key] || 0) + row[key];
                    }
                });
                });
                
                if (JSON.stringify(columnSums) != '{}') {
                    const mainRowTotal = `
                    <tr id="mainTotal" class="mainTotal_sum bg-secondary table-secondary text-success" style="background-color:#234db5 !important;">
                    <td></td>
                    <td>Total</td>
                    <td>${columnSums.salary}</td>
                    <td>${columnSums.contingencies}</td>
                    <td>${columnSums.non_contingencies}</td>
                    <td>${columnSums.recurring}</td>
                    <td>${columnSums.travel}</td>
                    <td>${columnSums.overhead_expens}</td>
                    <td>${columnSums.total}</td>
                    <td>${columnSums.subtotal}</td>
                    <td></td>
                    </tr>
                `;
                $tbody.append(mainRowTotal);
                }else{
                const mainRowTotal = `
                    <tr id="mainTotal" class="mainTotal_zero table-secondary">
                    <td></td>
                    <td>Total</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td></td>
                    <td></td>
                    </tr>
                `;
                $tbody.append(mainRowTotal);
                }
       
            $('.edit-toggle').on('change', function(){
            const row = $(this).closest('tr');
            var isChecked = $(this).prop('checked');
            row.find('.edit-input').prop('disabled', !isChecked);
        });

        
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });

}
$(document).ready(function(){
    reloadTable()
    const params_get = new URLSearchParams(document.location.search);
        const pi_id = params_get.get("pi_id");
        const projectid = params_get.get("project_id");
    $.ajax({
            url: '/get_balance_sheet/',  // Django URL 
            data: {
                'projectpi_id': pi_id,
                'project_id': projectid,
            },
            success: function(response) {
                if (response.status === "200 OK") {
                    console.log('Balance Sheet:',response)
                    const newData = response.data;

                    // $("#balanceSheetTbody").empty()

                    // for (const key in response.keys) {
                    //     // $(`#${key}`).append(`<td>${newData[key]}</td>`);
                    //     console.log('keys',key)
                    //     console.log(newData[key])
                    // }
                    
                        
                    // for(i=0;i<newData.length;i++){
                    //     console.log(newData[i])
                    
                    // }

                    const keys = Object.keys(newData[0]);
                    if ($('#balanceSheetTbody').is(':empty')) {
                        keys.forEach(key => {
                        $('#balanceSheetTbody').append(`<tr data-field="${key}"><td>${key}</td></tr>`);
                        });
                    }
                    const colIndex = ["Sanction","Release","UC","Uspend"].length; // count columns
  
                    // if(i<colIndex){
                    for (j=0;j<colIndex;j++){
                    const col_name = ["Sanction","Release","UC","Unspend"]
                    $('#headerRow').append(`<th> ${col_name[j]}</th>`);
                        
                    console.log("data length",newData[j])
                    if(newData[j]) {
                    // Append column data (vertical)
                    keys.forEach(key => {
                        $(`#balanceSheetTbody tr[data-field='${key}']`).append(`<td>${newData[j][key]}</td>`);
                    });
                    }
                    i +=1
                    }
                    
                }
            }
        });
})
var financialId = 0
var i = 0
$(document).ready(function() {
    $(document).on("change","input[type=radio]",function(){
        debugger
        financialId = $(this).val();
        const params_get = new URLSearchParams(document.location.search);
        const pi_id = params_get.get("pi_id");
        const projectid = params_get.get("project_id");

    // console.log('pi_id',pi_id)
    // console.log('projectid',projectid)
        $.ajax({
            url: '/get-releases/',  // Django URL
            data: {
                'financial_id': financialId,
                'projectpi_id': pi_id,
                'project_id': projectid,
            },
            success: function(data) {
                    $("#ReleaseTbody").empty()
                    data.data.forEach((release, index) => {
                    const html = `
                    <tr id="Trow-${index}" class="main-row" data-index="${index}" data-set-id="${release.id}">
                    <td></td>
                    <td class="text-warning">${release.release_no}</td>
                    <td class="text-muted">${release.salary}</td>
                    <td class="text-muted">${release.contingencies}</td>
                    <td class="text-muted">${release.non_contingencies}</td>
                    <td class="text-muted">${release.recurring}</td>
                    <td class="text-muted">${release.travel}</td>
                    <td class="text-muted">${release.overhead_expens}</td>
                    <td class="text-success">${release.total}</td>
                    <td class="text-muted comment" data-bs-toggle="tooltip" data-bs-placement="top" title="${release.comment}">${release.comment}</td>
                    <td class=""><a href="{{MEDIA_URL}}${release.fileupload}" target="_blank">View</a></td>
                    <td class=""><a href="#" class="text-warning" data-bs-toggle="modal" data-bs-target="#releaseModal"><i class="far fa-edit"></i></a></td>
                    </tr>
                `;
                
                $("#ReleaseTbody").append(html);
                });
                const releaseSums = {};

                data.data.forEach(row => {
                Object.keys(row).forEach(key => {
                    if (typeof row[key] === 'number' && key !== 'id') {
                    releaseSums[key] = (releaseSums[key] || 0) + row[key];
                    }
                });
                });
                
                if (JSON.stringify(releaseSums) != '{}') {
                    const mainRowTotal = `
                    <tr id="releaseTotal" class="mainTotal_sum bg-secondary table-secondary text-success" style="background-color:#234db5 !important;">
                    <td></td>
                    <td>Total</td>
                    <td id="total_releasesalary">${releaseSums.salary}</td>
                    <td id="total_releasecontingencies">${releaseSums.contingencies}</td>
                    <td id="total_releasenon_contingencies">${releaseSums.non_contingencies}</td>
                    <td id="total_releaserecurring">${releaseSums.recurring}</td>
                    <td id="total_releasetravel">${releaseSums.travel}</td>
                    <td id="total_releaseoverhead_expens">${releaseSums.overhead_expens}</td>
                    <td>${releaseSums.total}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    </tr>
                `;
                $("#ReleaseTbody").append(mainRowTotal);
                }else{
                const mainRowTotal = `
                    <tr id="releaseTotal" class="mainTotal_zero table-secondary">
                    <td></td>
                    <td>Total</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    </tr>
                `;
               $("#ReleaseTbody").append(mainRowTotal);
                }
            }
        });


        $.ajax({
            url: '/get_uc/',  // Django URL
            data: {
                'financial_id': financialId,
                'projectpi_id': pi_id,
                'project_id': projectid,
            },
            success: function(data) {
                    $("#UCTbody").empty()
                    data.data.forEach((uc, index) => {
                    const html = `
                    <tr id="Trow-${index}" class="main-row" data-index="${index}" data-set-id="${uc.id}">
                    <td></td>
                    <td class="outer-year text-warning">${uc.uc_no}</td>
                    <td class="text-muted">${uc.salary}</td>
                    <td class="text-muted">${uc.contingencies}</td>
                    <td class="text-muted">${uc.non_contingencies}</td>
                    <td class="text-muted">${uc.recurring}</td>
                    <td class="text-muted">${uc.travel}</td>
                    <td class="text-muted">${uc.overhead_expens}</td>
                    <td class="text-muted text-success">${uc.total}</td>
                    <td class="text-muted text-success">${uc.interest}</td>
                    <td class="text-muted comment" data-bs-toggle="tooltip" data-bs-placement="top" title="${uc.comment}">${uc.comment}</td>
                    <td class="text-muted"><a href="{{MEDIA_URL}}${uc.fileupload}" target="_blank">View</a></td>
                    <td class=""><a href="#" class="text-warning" data-bs-toggle="modal" data-bs-target="#ucModal"><i class="far fa-edit"></i></a></td>
                    </tr>
                `;
                
                $("#UCTbody").append(html);
                });
            }
        });

        $.ajax({
            url: '/get_balance/',  // Django URL
            data: {
                'financial_id': financialId,
                'projectpi_id': pi_id,
                'project_id': projectid,
            },
            success: function(data) {
                    $("#balanceTbody").empty()
                    data.data.forEach((balance, index) => {
                    const html = `
                    <tr id="Trow-${index}" class="main-row" data-index="${index}" data-set-id="${balance.id}">
                    <td></td>
                    <td class="text-muted">${balance.year}</td>
                    <td class="text-muted">${balance.salary}</td>
                    <td class="text-muted">${balance.contingencies}</td>
                    <td class="text-muted">${balance.non_contingencies}</td>
                    <td class="text-muted">${balance.recurring}</td>
                    <td class="text-muted">${balance.travel}</td>
                    <td class="text-muted">${balance.overhead_expens}</td>
                    <td class="text-muted text-success">${balance.interest}</td>
                    <td class="text-muted text-success">${balance.total}</td>
                    </tr>
                `;
                
                $("#balanceTbody").append(html);
                });
            }
        });

        
    });
});




















    var rowlock = 0
    function AddNewrow() {
    debugger;
    var rowCount = $('#sansion-table tr').length;
    console.log('rowCount',rowCount)
    var newrow = 0
   
    var yeararray = ["1st","2nd","3rd","4th","5th"]
    var newrow = $(`#sansion-table tbody tr`).length - 1
    var nextYear = yeararray[newrow]
      
    let newRow = ''
    if (newrow >= 4){ $('#addnewrow').css('display','none')}

    if(rowlock === 0){
    
        newRow = `
        <tr data-set-id="new" class="seq" id="newrow">
            <td><button class="" onclick="delBtnOuter(this)" style="color:red;">X</button></td>
            <td><input type="text" id="year" name="year" placeholder="Enter Year" value="${nextYear}" disabled></td>
            <td><input type="number" id="salary" name="salary" placeholder="Enter salary" ></td>
            <td><input type="number" id="contingencies" name="contingencies" placeholder="Enter Contingencies" ></td>
            <td><input type="number" id="noncontingencies" name="noncontingencies" placeholder="Enter Noncontingencies" ></td>
            <td><input type="number" id="recurring"  name="recurring" placeholder="Enter Recurring" ></td>
            <td><input type="number" id="travel" name="travel" placeholder="Enter Travel" ></td>
            <td><input type="number" id="overheadexpens"  name="overheadexpens" placeholder="Enter Overhead expens"></td>
            <td><input type="number" id="id_outertotal" name="total" disabled></td>
            <td><button id="sensionSave" onclick="senssionFormSubmit(this)">Save</td>
        </tr>
        `;
        
        $(`#mainTotal`).before(newRow);
        rowlock +=1
    }
    };
        
  // Optional: Handle delete row
  function delBtnOuter(d) {
    $(d).closest('tr').remove();
    rowlock=0
    reloadTable()
  };


  var releasRowLock = 0  
  function AddRelease() {
    var selectedVal = $('input[name="financial_select"]:checked').val();
    if(selectedVal){
        if(releasRowLock === 0){
            newRow = `
                <tr data-set-id="new" class="seq" id="newrow">
                    <td><button class="" onclick="delBtnRelease(this)" style="color:red;">X</button></td>
                    <td><input type="text" id="release_year" name="year" placeholder="Enter Year" disabled></td>
                    <td><input type="number" id="release_salary" name="salary" placeholder="Enter salary" onchange="releaseCalculate(this);" required></td>
                    <td><input type="number" id="release_contingencies" name="contingencies" placeholder="Enter Contingencies" onchange="releaseCalculate(this);" required></td>
                    <td><input type="number" id="release_noncontingencies" name="noncontingencies" placeholder="Enter Noncontingencies" onchange="releaseCalculate(this);" required></td>
                    <td><input type="number" id="release_recurring"  name="recurring" placeholder="Enter Recurring" onchange="releaseCalculate(this);" required></td>
                    <td><input type="number" id="release_travel" name="travel" placeholder="Enter Travel" onchange="releaseCalculate(this);" required></td>
                    <td><input type="number" id="release_overheadexpens"  name="overheadexpens" placeholder="Enter Overhead expens" onchange="releaseCalculate(this);" required></td>
                    <td><input type="number" id="id_releasetotal" name="total" disabled></td>
                    <td><input type="text" id="release_comment" placeholder="Enter Comment" value=""></td>
                    <td><input type="file" id="release_fileupload" placeholder="Enter fileupload" name="fileupload" required></td>
                    <td><button id="releaseFormSave" onclick="releaseFormSubmit(this)">Save</td>
                </tr>
            `;
            
            $(`#releaseTotal`).before(newRow);
            releasRowLock += 1
            }
        }else{
            swal("Please first select finance year!!",{
                buttons: {
                    confirm: {
                    className: "btn btn-success",
                    },
                },});
        }
    };
        
  // Optional: Handle delete row
  function delBtnRelease(d) {
    $(d).closest('tr').remove();
    releasRowLock = 0
  };
  
  var ucRowLock = 0
  function Adduc() {
    
    if(ucRowLock === 0){
        newRow = `
            <tr data-set-id="new" class="seq" id="newrow">
                <td><button class="" onclick="delBtnUc(this)" style="color:red;">X</button></td>
                <td><input type="text" id="uc_year" name="year" placeholder="Enter Year" value="" disabled></td>
                <td><input type="number" id="uc_salary" name="salary" placeholder="Enter salary" onchange="ucCalcTotal(this);"></td>
                <td><input type="number" id="uc_contingencies" name="contingencies" placeholder="Enter Contingencies" onchange="ucCalcTotal(this);"></td>
                <td><input type="number" id="uc_noncontingencies" name="noncontingencies" placeholder="Enter Noncontingencies" onchange="ucCalcTotal(this);"></td>
                <td><input type="number" id="uc_recurring"  name="recurring" placeholder="Enter Recurring" onchange="ucCalcTotal(this);"></td>
                <td><input type="number" id="uc_travel" name="travel" placeholder="Enter Travel" onchange="ucCalcTotal(this);"></td>
                <td><input type="number" id="uc_overheadexpens"  name="overheadexpens" placeholder="Enter Overhead expens" onchange="ucCalcTotal(this);"></td>
                <td><input type="number" id="uc_total" name="total" disabled></td>
                <td><input type="number" id="uc_interest" name="interest"></td>
                <td><input type="text" id="uc_comment" name="comment"></td>
                <td><input type="file" id="uc_fileupload" placeholder="Enter fileupload" name="fileupload"></td>
                <td><button id="ucFormSave" onclick="uc_FormSubmit(this)">Save</td>
            </tr>
        `;
        
        $(`#UCTbody`).append(newRow);
        ucRowLock += 1
        }
    };
        
  // Optional: Handle delete row
  function delBtnUc(d) {
    $(d).closest('tr').remove();
    ucRowLock = 0
  };

// senssion data submit 

function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

function validateYearForm(){
    let isValid = true;
    var year = $('#year').val()
    var salary = $('#salary').val()
    var contingencies = $('#contingencies').val()
    var noncontingencies = $('#noncontingencies').val()
    var recurring = $('#recurring').val()
    var travel = $('#travel').val()
    var overheadexpens = $('#overheadexpens').val()

   
    if (year === "") {
        $('#year').css("border-color","red")
        isValid = false;
    }
    
    if (salary === "") {
        $('#salary').css("border-color","red")
        isValid = false;
    }
    
    if (contingencies === "") {
        $('#contingencies').css("border-color","red")
        isValid = false;
    }
    
    if (noncontingencies === "") {
        $('#noncontingencies').css("border-color","red")
        isValid = false;
    }
    
    if (recurring === "") {
        $('#recurring').css("border-color","red")
        isValid = false;
    }
    
    if (travel === "") {
        $('#travel').css("border-color","red")
        isValid = false;
    }
    
    if (overheadexpens === "") {
        $('#overheadexpens').css("border-color","red")
        isValid = false;
    }
    return isValid
}

function senssionFormSubmit(v){
   debugger;
    var id = v.parentElement.parentElement.dataset.setId
    const params_get = new URLSearchParams(document.location.search);
    const pi_id = params_get.get("pi_id");
    const projectid = params_get.get("project_id");
    var formData = new FormData()
    
    var projectpi = pi_id
    var projects = projectid
    
    
    var year = $('#year').val()
    var salary = $('#salary').val()
    var contingencies = $('#contingencies').val()
    var noncontingencies = $('#noncontingencies').val()
    var recurring = $('#recurring').val()
    var travel = $('#travel').val()
    var overheadexpens = $('#overheadexpens').val()
    var total = $('#id_outertotal').val()
    var comment = $('#id_comment').val()
    
    formData.append('projectpi',projectpi);
    formData.append('projects',projects);
    formData.append('year',year);
    formData.append('salary',salary);
    formData.append('contingencies',contingencies);
    formData.append('noncontingencies',noncontingencies);
    formData.append('recurring',recurring);
    formData.append('travel',travel);
    formData.append('overheadexpens',overheadexpens);
    // formData.append('uploadfile',uploadfile);
    formData.append('total',total);
    
    var valid = validateYearForm()    
    // valid = false
    if(valid){
    $.ajax({
        url: "{% url 'senssion_submit' %}",      // Your Django URL for upload
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        headers: { 'X-CSRFToken': getCookie('csrftoken') },  // CSRF token included
        success: function(response) {
            rowlock = 0
            reloadTable()
            swal(response.message,{
                buttons: {
                    confirm: {
                    className: "btn btn-success",
                    },
                },});
            
        },
        error: function(xhr, status, error) {
            swal(response.message,{
                buttons: {
                    confirm: {
                    className: "btn btn-danger",
                    },
                },});
            
        }
        });
    }else{
        console.error(error);
        swal("Please fill complete form.",{
                buttons: {
                    confirm: {
                    className: "btn btn-danger",
                    },
                },});}

    
        

}



$("#id_selectYearMsgRelease").hide()
$("#id_selectYearMsguc").hide()
var senssion_year=''
var senssion_salary=0
var senssion_contingencies=0
var senssion_nonContingencies=0
var senssion_recurring=0
var senssion_travel=0
var senssion_overheadexpens=0

$(document).ready(function() {
   $(document).on("change","input[type=radio]",function(){
    var financialId = $(this).val();
    var row = $(this).closest('tr');

    // Extract the values from the row cells
    senssion_year= row.find('td').eq(1).text();
    senssion_salary = row.find('td').eq(2).text();
    senssion_contingencies = row.find('td').eq(3).text();
    senssion_nonContingencies = row.find('td').eq(4).text();
    senssion_recurring = row.find('td').eq(5).text();
    senssion_travel = row.find('td').eq(6).text();
    senssion_overheadexpens = row.find('td').eq(7).text();
    

    // Optional: Compare with existing release rows or show differences
    
    $("#id_selectYearMsgRelease").text(`You have selected ${senssion_year} year`)
    $("#id_selectYearMsgRelease").css("background-color","#f1d1d1")
    $("#id_selectYearMsgRelease").show()

    // Add the new row to release table
    var newRow = '<tr>' +
      '<td>' + senssion_salary + '</td>' +
      '<td>' + senssion_contingencies + '</td>' +
      '<td>' + senssion_nonContingencies + '</td>' +
      '<td>' + senssion_recurring + '</td>' +
      '<td>' + senssion_travel + '</td>' +
      '<td>' + senssion_overheadexpens + '</td>' +
      '</tr>';

    console.log(newRow)


  });
});

function releaseCalculate(v)
{
//    debugger
   
	var salary = $('#release_salary').val()

    // $('#release_salary').val(Number(salary)+1000)
    if(Number(salary) > Number(senssion_salary)){
        $('#release_salary').css("border-color","red")
        swal("Please Check, Senssion salary should be greater than release Salary",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#release_salary').css("border-color","")}
	var contingencies = $("#release_contingencies").val()
    if(Number(contingencies)>Number(senssion_contingencies)){
        $('#release_contingencies').css("border-color","red")
        swal("Please Check, Senssion contingencies should be greater than release contingencies",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#release_contingencies').css("border-color","")}
	var noncontingencies = $("#release_noncontingencies").val()
    if(Number(noncontingencies)>Number(senssion_nonContingencies)){
        $('#release_noncontingencies').css("border-color","red")
        swal("Please Check, Senssion Non contingencies should be greater than release Non contingencies",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#release_noncontingencies').css("border-color","")}
	var recurring = $("#release_recurring").val()
    if(Number(recurring)>Number(senssion_recurring)){
        $('#release_recurring').css("border-color","red")
        swal("Please Check, Senssion Non contingencies should be greater than release Non contingencies",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#release_recurring').css("border-color","")}
	var travel = $("#release_travel").val()
    if(Number(travel)>Number(senssion_travel)){
        $('#release_travel').css("border-color","red")
        swal("Please Check, Senssion travel should be greater than release travel",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#release_travel').css("border-color","")}
	var overhead = $("#release_overheadexpens").val()
    if(Number(overhead)>Number(senssion_overheadexpens)){
        $('#release_overheadexpens').css("border-color","red")
        swal("Please Check, Senssion overhead should be greater than release overhead",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#release_overheadexpens').css("border-color","")}
    
     
    var amt = +(salary)+  +(contingencies)+  +(noncontingencies)+  +(recurring)+  +(travel)+  +(overhead)
	$("#id_releasetotal").val(amt)
    console.log('Total Amount:',amt)
    
    var salary_total = $("#total_releasesalary").text();
    var contingencies_total = $("#total_releasecontingencies").text();
    var non_contingencies_total = $("#total_releasenon_contingencies").text();
    var recurring_total = $("#total_releaserecurring").text();
    var travel_total = $("#total_releasetravel").text();
    var overhead_expens_total = $("#total_releaseoverhead_expens").text();

    var tot_salary_sanction = parseFloat(salary_total)+parseFloat(salary)
    var tot_contingencies_sanction = parseFloat(contingencies_total)+parseFloat(contingencies)
    var tot_noncontingencies_sanction = parseFloat(non_contingencies_total)+parseFloat(noncontingencies)
    var tot_recurring_sanction = parseFloat(recurring_total)+parseFloat(recurring)
    var tot_travel_sanction = parseFloat(travel_total)+parseFloat(travel)
    var tot_overhead_sanction = parseFloat(overhead_expens_total)+parseFloat(overhead)
    debugger;
    $.ajax({
        url: '/check_release_limit/',  // Django URL
        data: {
            'finance_id': financialId
        },
        success: function(response) {
                console.log('release each field total before submit check')
                console.log("**************************************************")
                console.log(response)
                console.log(response.data)
                console.log(response.finance_row)
                console.log(response.finance_row[0].salary)
                console.log("**************************************************")
                if(tot_salary_sanction > response.finance_row[0].salary){
                    $('input[name=salary]').val("")
                    swal("Please Check, Salary is not allowed greater than Sanction salary!!",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
                }
                if(tot_contingencies_sanction > response.finance_row[0].contingencies){
                    $('input[name=contingencies]').val("")
                    swal("Please Check, Contingencies is not allowed greater than Sanction contingencies!!",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
                }
                if(tot_noncontingencies_sanction > response.finance_row[0].non_contingencies){
                    $('input[name=noncontingencies]').val("")
                    swal("Please Check,Non-Contingencies is not allowed greater than Sanction Non-contingencies!!",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
                }
                if(tot_recurring_sanction > response.finance_row[0].recurring){
                    $('input[name=recurring]').val("")
                    swal("Please Check,Recurring is not allowed greater than Sanction recurring!!",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
                }
                if(tot_travel_sanction > response.finance_row[0].travel){
                    $('input[name=travel]').val("")
                    swal("Please Check,Travel is not allowed greater than Sanction travel!!",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
                }
                if(tot_overhead_sanction > response.finance_row[0].overhead_expens){
                    $('input[name=overheadexpens]').val("")
                    swal("Please Check,Overheadexpens is not allowed greater than Sanction Overheadexpens!!",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
                }

        }
    });
}



function validateReleaseForm(){
    let isValid = true;
    var year = $('#release_year').val()
    var salary = $('#release_salary').val()
    var contingencies = $('#release_contingencies').val()
    var noncontingencies = $('#release_noncontingencies').val()
    var recurring = $('#release_recurring').val()
    var travel = $('#release_travel').val()
    var overheadexpens = $('#release_overheadexpens').val()
    var fileInput = $('#release_fileupload')[0];
    

    // if (year === "") {
    //     $('#year').css("border-color","red")
    //     isValid = false;
    // }
    
    if (salary === "") {
        $('#release_salary').css("border-color","red")
        isValid = false;
    }
    
    if (contingencies === "") {
        $('#release_contingencies').css("border-color","red")
        isValid = false;
    }
    
    if (noncontingencies === "") {
        $('#release_noncontingencies').css("border-color","red")
        isValid = false;
    }
    
    if (recurring === "") {
        $('#release_recurring').css("border-color","red")
        isValid = false;
    }
    
    if (travel === "") {
        $('#release_travel').css("border-color","red")
        isValid = false;
    }
    
    if (overheadexpens === "") {
        $('#release_overheadexpens').css("border-color","red")
        isValid = false;
    }
    
    if (fileInput.files.length === 0) {
      $('#release_fileupload').css("border-color","red")
      isValid = false;
    }
    if (fileInput.files.length !== 0) {
        var file = fileInput.files[0];
        var fileType = file.type;
        if (fileType !== 'application/pdf') {
        swal("Upload only PDF File.",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    isValid = false;
        }
    }
    if(Number(salary)>Number(senssion_salary)){
        isValid = false;
    }
    if(Number(contingencies)>Number(senssion_contingencies)){
        isValid = false;
    }
    if(Number(noncontingencies)>Number(senssion_nonContingencies)){
        isValid = false;
    }
    if(Number(recurring)>Number(senssion_recurring)){
        isValid = false;
    }
    if(Number(travel)>Number(senssion_travel)){
        isValid = false;
    }
    if(Number(overheadexpens)>Number(senssion_overheadexpens)){
        isValid = false;
    }    
    return isValid
}


function releaseFormSubmit(v){
    debugger
    const params_get = new URLSearchParams(document.location.search);
    const pi_id = params_get.get("pi_id");
    const projectid = params_get.get("project_id");
    
    var formData = new FormData()
    
    var projectpi = pi_id
    var projects = projectid
    var selectedFinanceYear = $('input[name="financial_select"]:checked').val();
   
    var year_index = ["","1st","2nd","3rd","4th","5th"]
   if (senssion_year !== '1st'){
        var spl_year = Number(senssion_year.toString()[0])-1
        var getyear = year_index[spl_year]
        console.log('spl_year',spl_year)
        console.log('getyear',getyear)
        $.ajax({
            url: '/get_unpend_balance/',  // Django URL
            data: {
                'year': getyear,
                'projectpi_id': pi_id,
                'project_id': projectid,
                'finance_id':selectedFinanceYear,
            },
            success: function(data) {
                debugger
                    if (data.data.length !== 0){
                        // console.log("get response",data)
                        // console.log("get response salary",data.data[0].salary)
                        let salary1 = $("#release_salary").val()
                        let contingencies1 = $("#release_contingencies").val()
                        let noncontingencies1 = $("#release_noncontingencies").val()
                        let recurring1 = $("#release_recurring").val()
                        let travel1 = $("#release_travel").val()
                        let overheadexpens1 = $("#release_overheadexpens").val()

                        $("#release_salary").val(parseFloat(salary1)+data.data[0].salary)
                        $("#release_contingencies").val(parseFloat(contingencies1)+data.data[0].contingencies)
                        $("#release_noncontingencies").val(parseFloat(noncontingencies1)+data.data[0].non_contingencies)
                        $("#release_recurring").val(parseFloat(recurring1)+data.data[0].recurring)
                        $("#release_travel").val(parseFloat(travel1)+data.data[0].travel)
                        $("#release_overheadexpens").val(parseFloat(overheadexpens1)+data.data[0].overhead_expens)
                        releaseCalculate()
                        

                        var valid = validateReleaseForm()
                        if(valid){
                            debugger
                            var year = senssion_year
                            var salary = $("#release_salary").val()
                            var contingencies = $("#release_contingencies").val()
                            var noncontingencies = $("#release_noncontingencies").val()
                            var recurring = $("#release_recurring").val()
                            var travel = $("#release_travel").val()
                            var overheadexpens = $("#release_overheadexpens").val()
                            var uploadfile = $("#release_fileupload")[0]
                            var total = $("#id_releasetotal").val()
                            var comment = $("#release_comment").val()
                            var selectedFinanceYear = $('input[name="financial_select"]:checked').val();

                            formData.append('finance_id',selectedFinanceYear);
                            formData.append('projectpi',projectpi);
                            formData.append('projects',projects);
                            formData.append('year',year);
                            formData.append('salary',salary);
                            formData.append('contingencies',contingencies);
                            formData.append('noncontingencies',noncontingencies);
                            formData.append('recurring',recurring);
                            formData.append('travel',travel);
                            formData.append('overheadexpens',overheadexpens);
                            formData.append('uploadfile',uploadfile);
                            formData.append('total',total);
                            if (uploadfile.files.length > 0) {
                                formData.append('uploadfile', uploadfile.files[0]);
                            } else {
                                formData.append('uploadfile', '');
                            }
                            formData.append('comment',comment);
                            $.ajax({
                                url: "{% url 'release_submit' %}",      // Your Django URL for upload
                                type: 'POST',
                                data: formData,
                                contentType: false,
                                processData: false,
                                headers: { 'X-CSRFToken': getCookie('csrftoken') },  // CSRF token included
                                success: function(response) {
                                    if(response.status == '400 BAD_REQUEST'){
                                        swal(response.message,{
                                        buttons: {
                                            confirm: {
                                            className: "btn btn-danger",
                                            },
                                        },});
                                    }
                                    if(response.status == '200 OK'){
                                        $("input[type=radio][name=financial_select]:checked").trigger("change");
                                        releasRowLock = 0
                                    swal(response.message,{
                                        buttons: {
                                            confirm: {
                                            className: "btn btn-success",
                                            },
                                        },});
                                        // location.reload();
                                    }
                                    
                                },
                                error: function(xhr, status, error) {
                                    alert('Upload failed');
                                    console.error(error);
                                }
                            });
                            
                        }else{
                            swal("Please fill complete form.",{
                                    buttons: {
                                        confirm: {
                                        className: "btn btn-danger",
                                        },
                                    },});}
                                        alert("Unspent balance added!!!") 
                    }
                } 
        });                  
                                
            
                            

                                
    }else{
                               
    var year = senssion_year
    var salary = $("#release_salary").val()
    var contingencies = $("#release_contingencies").val()
    var noncontingencies = $("#release_noncontingencies").val()
    var recurring = $("#release_recurring").val()
    var travel = $("#release_travel").val()
    var overheadexpens = $("#release_overheadexpens").val()
    var uploadfile = $("#release_fileupload")[0]
    var total = $("#id_releasetotal").val()
    var comment = $("#release_comment").val()
    

    formData.append('finance_id',selectedFinanceYear);
    formData.append('projectpi',projectpi);
    formData.append('projects',projects);
    formData.append('year',year);
    formData.append('salary',salary);
    formData.append('contingencies',contingencies);
    formData.append('noncontingencies',noncontingencies);
    formData.append('recurring',recurring);
    formData.append('travel',travel);
    formData.append('overheadexpens',overheadexpens);
    formData.append('uploadfile',uploadfile);
    formData.append('total',total);
    if (uploadfile.files.length > 0) {
        formData.append('uploadfile', uploadfile.files[0]);
    } else {
        formData.append('uploadfile', '');
    }
    formData.append('comment',comment);
    var valid = validateReleaseForm()
    if(valid){
        debugger
        var year = senssion_year
        var salary = $("#release_salary").val()
        var contingencies = $("#release_contingencies").val()
        var noncontingencies = $("#release_noncontingencies").val()
        var recurring = $("#release_recurring").val()
        var travel = $("#release_travel").val()
        var overheadexpens = $("#release_overheadexpens").val()
        var uploadfile = $("#release_fileupload")[0]
        var total = $("#id_releasetotal").val()
        var comment = $("#release_comment").val()
        var selectedFinanceYear = $('input[name="financial_select"]:checked').val();

        formData.append('finance_id',selectedFinanceYear);
        formData.append('projectpi',projectpi);
        formData.append('projects',projects);
        formData.append('year',year);
        formData.append('salary',salary);
        formData.append('contingencies',contingencies);
        formData.append('noncontingencies',noncontingencies);
        formData.append('recurring',recurring);
        formData.append('travel',travel);
        formData.append('overheadexpens',overheadexpens);
        formData.append('uploadfile',uploadfile);
        formData.append('total',total);
        if (uploadfile.files.length > 0) {
            formData.append('uploadfile', uploadfile.files[0]);
        } else {
            formData.append('uploadfile', '');
        }
        formData.append('comment',comment);
        $.ajax({
        url: "{% url 'release_submit' %}",      // Your Django URL for upload
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        headers: { 'X-CSRFToken': getCookie('csrftoken') },  // CSRF token included
        success: function(response) {
            if(response.status == '400 BAD_REQUEST'){
                swal(response.message,{
                buttons: {
                    confirm: {
                    className: "btn btn-danger",
                    },
                },});
            }
            if(response.status == '200 OK'){
                releasRowLock = 0
                $("input[type=radio][name=financial_select]:checked").trigger("change");
            swal(response.message,{
                buttons: {
                    confirm: {
                    className: "btn btn-success",
                    },
                },});
                // location.reload();
            }
            
        },
        error: function(xhr, status, error) {
            alert('Upload failed');
            console.error(error);
        }
    });
        
    }else{
        swal("Please fill complete form.",{
                buttons: {
                    confirm: {
                    className: "btn btn-danger",
                    },
                },});}

   }             
    
}


// uc form submit


function ucCalcTotal(v)
{
   debugger
	var salary = $('#uc_salary').val()
    if(Number(salary) > Number(senssion_salary)){
        $('#uc_salary').css("border-color","red")
        swal("Please Check, Senssion salary should be greater than release Salary",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#uc_salary').css("border-color","")}
	var contingencies = $("#uc_contingencies").val()
    if(Number(contingencies)>Number(senssion_contingencies)){
        $('#uc_contingencies').css("border-color","red")
        swal("Please Check, Senssion contingencies should be greater than release contingencies",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#uc_contingencies').css("border-color","")}

	var noncontingencies = $("#uc_noncontingencies").val()
    if(Number(noncontingencies)>Number(senssion_nonContingencies)){
        $('#uc_noncontingencies').css("border-color","red")
        swal("Please Check, Senssion Non contingencies should be greater than release Non contingencies",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#uc_noncontingencies').css("border-color","")}

	var recurring = $("#uc_recurring").val()
    if(Number(recurring)>Number(senssion_recurring)){
        $('#uc_recurring').css("border-color","red")
        swal("Please Check, Senssion Non contingencies should be greater than release Non contingencies",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#uc_recurring').css("border-color","")}

	var travel = $("#uc_travel").val()
    if(Number(travel)>Number(senssion_travel)){
        $('#uc_travel').css("border-color","red")
        swal("Please Check, Senssion travel should be greater than release travel",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#uc_travel').css("border-color","")}

	var overhead = $("#uc_overheadexpens").val()
    if(Number(overhead)>Number(senssion_overheadexpens)){
        $('#uc_overheadexpens').css("border-color","red")
        swal("Please Check, Senssion overhead should be greater than release overhead",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    
    }else{$('#uc_overheadexpens').css("border-color","")}
    
     
    var amt = +(salary)+  +(contingencies)+  +(noncontingencies)+  +(recurring)+  +(travel)+  +(overhead)
	$("#uc_total").val(amt)
    console.log('Total Amount:',amt)
   
}


function validateUcForm(){
    let isValid = true;
    var year = $('#uc_year').val()
    var salary = $('#uc_salary').val()
    var contingencies = $('#uc_contingencies').val()
    var noncontingencies = $('#uc_noncontingencies').val()
    var recurring = $('#uc_recurring').val()
    var travel = $('#uc_travel').val()
    var overheadexpens = $('#uc_overheadexpens').val()
    var fileInput = $('#uc_fileupload')[0];
    

    // if (year === "") {
    //     $('#year').css("border-color","red")
    //     isValid = false;
    // }
    
    if (salary === "") {
        $('#uc_salary').css("border-color","red")
        isValid = false;
    }
    
    if (contingencies === "") {
        $('#uc_contingencies').css("border-color","red")
        isValid = false;
    }
    
    if (noncontingencies === "") {
        $('#uc_noncontingencies').css("border-color","red")
        isValid = false;
    }
    
    if (recurring === "") {
        $('#uc_recurring').css("border-color","red")
        isValid = false;
    }
    
    if (travel === "") {
        $('#uc_travel').css("border-color","red")
        isValid = false;
    }
    
    if (overheadexpens === "") {
        $('#uc_overheadexpens').css("border-color","red")
        isValid = false;
    }
    
    if (fileInput.files.length === 0) {
      $('#uc_fileupload').css("border-color","red")
      isValid = false;
    }
    if (fileInput.files.length !== 0) {
        var file = fileInput.files[0];
        var fileType = file.type;
        if (fileType !== 'application/pdf') {
        swal("Upload only PDF File.",{
                    buttons: {
                        confirm: {
                        className: "btn btn-danger",
                        },
                    },});
                    isValid = false;
        }
    }
    if(Number(salary)>Number(senssion_salary)){
        isValid = false;
    }
    if(Number(contingencies)>Number(senssion_contingencies)){
        isValid = false;
    }
    if(Number(noncontingencies)>Number(senssion_nonContingencies)){
        isValid = false;
    }
    if(Number(recurring)>Number(senssion_recurring)){
        isValid = false;
    }
    if(Number(travel)>Number(senssion_travel)){
        isValid = false;
    }
    if(Number(overheadexpens)>Number(senssion_overheadexpens)){
        isValid = false;
    }    
    return isValid
}



function uc_FormSubmit(v){

    const params_get = new URLSearchParams(document.location.search);
    const pi_id = params_get.get("pi_id");
    const projectid = params_get.get("project_id");
    
    var formData = new FormData()
    
    var projectpi = pi_id
    var projects = projectid
    
   
    var year = senssion_year
    var salary = $("#uc_salary").val()
    var contingencies = $("#uc_contingencies").val()
    var noncontingencies = $("#uc_noncontingencies").val()
    var recurring = $("#uc_recurring").val()
    var travel = $("#uc_travel").val()
    var overheadexpens = $("#uc_overheadexpens").val()
    var uploadfile = $("#uc_fileupload")[0]
    var total = $("#uc_total").val()
    var interest = $("#uc_interest").val()
    var comment = $("#uc_comment").val()
    var selectedFinanceYear = $('input[name="financial_select"]:checked').val();

    formData.append('finance_id',selectedFinanceYear);
    formData.append('projectpi',projectpi);
    formData.append('projects',projects);
    formData.append('year',year);
    formData.append('salary',salary);
    formData.append('contingencies',contingencies);
    formData.append('noncontingencies',noncontingencies);
    formData.append('recurring',recurring);
    formData.append('travel',travel);
    formData.append('overheadexpens',overheadexpens);
    formData.append('uploadfile',uploadfile);
    formData.append('total',total);
    formData.append('interest',interest);
    if (uploadfile.files.length > 0) {
        formData.append('uploadfile', uploadfile.files[0]);
    } else {
        formData.append('uploadfile', '');
    }
    // formData.append('total',total);
    formData.append('comment',comment);
    var valid = validateUcForm()
    if(valid){
        $.ajax({
        url: "{% url 'uc_submit' %}",      // Your Django URL for upload
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        headers: { 'X-CSRFToken': getCookie('csrftoken') },  // CSRF token included
        success: function(response) {
            if(response.status == '400 BAD_REQUEST'){
                swal(response.message,{
                buttons: {
                    confirm: {
                    className: "btn btn-danger",
                    },
                },});
            }
            if(response.status == '200 OK'){
                $("input[type=radio][name=financial_select]:checked").trigger("change");
            swal(response.message,{
                buttons: {
                    confirm: {
                    className: "btn btn-success",
                    },
                },});
                // location.reload();
            }
            
        },
        error: function(xhr, status, error) {
            alert('Upload failed');
            console.error(error);
        }
        });
        
    }else{
        swal("Please fill complete form.",{
                buttons: {
                    confirm: {
                    className: "btn btn-danger",
                    },
                },});}
    
}

</script>
{% endblock %}